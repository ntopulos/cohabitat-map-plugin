<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spin.js/4.1.0/spin.min.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://www.unpkg.com/spin@0.0.1/dist/spin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.Spin/1.1.2/leaflet.spin.min.js"></script>


<div id="mapid" style="width: 100%; height: 100%;"></div>

<style>
  #mapid img.leaflet-marker-icon{
    filter: brightness(0.7) saturate(0.8) hue-rotate(72deg) ;
  }
  .leaflet-tooltip{
    font-weight: bolder;
    font-size: 110%;
  }

  .marker-cluster{background-color: rgba(112, 50, 150, 0.4);}
  .marker-cluster div {background-color: rgba(112, 50, 150, 0.6);  }
</style>

<script>

  // Config
  const PARTNER_ID = 'b79f083b-412c-410e-abe7-0fd402c6afbf';
  const ENDPOINT = `https://api.cohabitat.io/partners/${PARTNER_ID}`;
  const PROJECT_URL = 'https://cohabitat.io/en/projects/';
  const BACKGROUND = 'https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png';

  // Map
  var mymap = L.map('mapid');
  mymap.attributionControl.setPrefix('<a href="https://cohabitat.io">CoHabitat.io</a>');
  mymap.spin(true);
  // mymap.setView([51.505, -0.09], 13);

  L.tileLayer(
    BACKGROUND,
    {
      attribution: 'Background : <a href="https://www.openstreetmap.org/">OpenStreetMap</a>/<a href="https://www.carto.com/">Carto</a>',
      maxZoom: 18,
      minZoom: 2,
    }
  ).addTo(mymap);

  var bounds = [[-90, -180], [90, 180]];
  mymap.setMaxBounds(bounds);
  mymap.on('drag', function() {
    mymap.panInsideBounds(bounds, { animate: false });
  });

  // Query
  var xhr = new XMLHttpRequest();
  xhr.open('GET', ENDPOINT);
  xhr.setRequestHeader('Accept', 'application/vnd.cohabitat.v1+json')
  xhr.onload = function() {
    if (xhr.status === 200) {
      var markers = L.markerClusterGroup({showCoverageOnHover: false});
      function openWebsite(e){
        window.open(PROJECT_URL + this.options.uuid)
      }
      markers.on('click', function (a) {
        console.log('marker ' + a.layer);
      });
      var result = JSON.parse(xhr.responseText);
      for(i in result['included']){
        var project = result['included'][i];
        if( project.type != 'projects') {
          continue;
        }
        try {
          // L.circleMarker(project['attributes']['coordinates']).addTo(mymap);
          // L.marker(project['attributes']['coordinates']).addTo(mymap); // slow !
          var marker = new L.marker(project['attributes']['coordinates'], {uuid: project['id']});
          marker.bindTooltip(
            project['attributes']['name_short'] || project['attributes']['name'],
            {permanent: false, direction: 'bottom', interactive: true, offset: [-16, 28] }
          );
          marker.on('click', openWebsite);
          markers.addLayer(marker);
        } catch (error) {
          console.log("Could not load project : "+project);
        }
      }
      mymap.fitBounds(markers.getBounds());
      mymap.addLayer(markers);
    }
    else {
      console.log('Request failed.  Returned status of ' + xhr.status);
    }
    mymap.spin(false);
  };
  xhr.send();
</script>
