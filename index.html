<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spin.js/4.1.0/spin.min.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://www.unpkg.com/spin@0.0.1/dist/spin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.Spin/1.1.2/leaflet.spin.min.js"></script>

<div id="cohabitat-map" style="width: 100%; height: 100%;"></div>

<!-- Customize style -->
<style>
  #cohabitat-map img.leaflet-marker-icon{ filter: brightness(0.7) saturate(0.8) hue-rotate(72deg) ;  }
  .leaflet-tooltip{ font-weight: bolder; font-size: 110%; }
  .marker-cluster{background-color: rgba(112, 50, 150, 0.4);}
  .marker-cluster div {background-color: rgba(112, 50, 150, 0.6);  }
</style>

<script>

  // Config
  const PARTNER_ID = 'b79f083b-412c-410e-abe7-0fd402c6afbf';
  const ENDPOINT = `https://api.cohabitat.io/partners/${PARTNER_ID}`;
  const PROJECT_URL = 'https://cohabitat.io/en/projects/';
  const BACKGROUND = 'https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png';

  // Map
  var map = L.map('cohabitat-map');
  map.attributionControl.setPrefix('<a href="https://cohabitat.io">CoHabitat.io</a>');
  map.spin(true);

  // Background layer
  L.tileLayer(
    BACKGROUND,
    {
      attribution: 'Background : <a href="https://www.openstreetmap.org/">OpenStreetMap</a>/<a href="https://www.carto.com/">Carto</a>',
      maxZoom: 18, minZoom: 2,
    }
  ).addTo(map);

  // Restrict panning
  var bounds = [[-90, -180], [90, 180]];
  map.setMaxBounds(bounds);
  map.on('drag', function() {
    map.panInsideBounds(bounds, { animate: false });
  });

  // Query
  var xhr = new XMLHttpRequest();
  xhr.open('GET', ENDPOINT);
  xhr.setRequestHeader('Accept', 'application/vnd.cohabitat.v1+json')
  xhr.onload = function() {
    if (xhr.status === 200) {
      var markers = L.markerClusterGroup({showCoverageOnHover: false});
      function openWebsite(e){
        window.open(PROJECT_URL + this.options.uuid)
      }
      var result = JSON.parse(xhr.responseText);
      for(i in result['included']){
        var project = result['included'][i];
        if( project.type != 'projects') {
          continue;
        }
        try {
          var marker = new L.marker(project['attributes']['coordinates'], {uuid: project['id']});
          marker.bindTooltip(
            project['attributes']['name_short'] || project['attributes']['name'],
            {permanent: false, direction: 'bottom', interactive: true, offset: [-16, 28] }
          );
          marker.on('click', openWebsite);
          markers.addLayer(marker);
        } catch (error) {
          console.log("Could not load project : "+project);
        }
      }
      map.fitBounds(markers.getBounds());
      map.addLayer(markers);
    }
    else {
      console.log('Request failed.  Returned status of ' + xhr.status);
    }
    map.spin(false);
  };
  xhr.send();
</script>
